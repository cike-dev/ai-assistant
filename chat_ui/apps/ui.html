<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolvina AI Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Apply Inter font, ensuring smooth edges */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5; /* Light Telegram-like background */
        }
        /* Custom scrollbar styling (optional but nice touch) */
        .chat-area::-webkit-scrollbar {
            width: 6px;
        }
        .chat-area::-webkit-scrollbar-thumb {
            background-color: #b0b0b0;
            border-radius: 3px;
        }
        /* Hide default Tailwind focus ring on the input for a cleaner look */
        input:focus {
            outline: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 1. Pinned Header (Title Bar) -->
    <header class="fixed top-0 left-0 right-0 bg-white shadow-md z-10 p-4 border-b border-gray-200">
        <div class="max-w-xl mx-auto flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 3h10a2 2 0 012 2v14a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2z" />
            </svg>
            <h1 class="text-lg font-semibold text-gray-800">Wolvina AI Assistant</h1>
        </div>
    </header>

    <!-- 3. Chat Area (Scrollable space between header and footer) -->
    <main id="chat-area" class="flex-grow overflow-y-auto pt-16 pb-24 md:pb-28 chat-area p-4 max-w-xl mx-auto w-full">
        <!-- Messages will be injected here -->
        <div id="messages" class="space-y-4">
            <!-- Initial welcome message -->
            <div class="flex justify-start">
                <div class="bg-white p-3 rounded-xl shadow-sm max-w-xs md:max-w-md w-fit text-gray-800">
                    <p>Hello! I'm Wolvina, your AI assistant. How can I help you today?</p>
                    <div class="text-xs text-gray-500 mt-1 text-right">
                        <span id="welcome-timestamp"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spinner/Loading Indicator -->
        <div id="loading-spinner" class="flex justify-start hidden mt-4">
            <div class="bg-gray-200 p-3 rounded-xl shadow-sm max-w-xs md:max-w-md w-fit">
                <div class="flex items-center text-gray-600">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    pls wait...
                </div>
            </div>
        </div>
    </main>

    <!-- 2. Pinned Input Box (Footer) -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-3 shadow-2xl z-10">
        <div class="max-w-xl mx-auto flex items-center space-x-2">
            <input 
                type="text" 
                id="user-input" 
                placeholder="Type a message..." 
                autocomplete="off"
                class="flex-grow p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                onkeypress="if(event.key === 'Enter') document.getElementById('send-btn').click()"
            >
            <!-- 4. Stylish Send Button -->
            <button 
                id="send-btn" 
                onclick="sendMessage()" 
                class="p-3 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition duration-150 transform hover:scale-105 shadow-md disabled:bg-indigo-300"
                disabled
            >
                <!-- Send Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </footer>

    <script>
        const RASA_SERVER_URL = "https://example.com"; // *** CHANGE THIS TO YOUR RASA ACTION SERVER URL ***
        const chatArea = document.getElementById('messages');
        const inputField = document.getElementById('user-input');
        const sendButton = document.getElementById('send-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const maxRetries = 3;

        // Function to get current timestamp (e.g., 10:30 AM)
        function getTimestamp() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Set timestamp for the initial welcome message
        document.getElementById('welcome-timestamp').textContent = getTimestamp();

        // Enable/Disable send button based on input content
        inputField.addEventListener('input', () => {
            sendButton.disabled = inputField.value.trim() === '';
        });

        // 6. Configured message box logic
        function addMessage(text, isUser) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubbleClass = isUser
                ? 'bg-indigo-500 text-white rounded-xl rounded-br-none'
                : 'bg-white text-gray-800 rounded-xl rounded-tl-none shadow-sm border border-gray-100';

            messageWrapper.innerHTML = `
                <div class="p-3 ${bubbleClass} max-w-[75%] w-fit">
                    <p>${text}</p>
                    <!-- 5. Timestamp -->
                    <div class="text-xs ${isUser ? 'text-indigo-200' : 'text-gray-500'} mt-1 text-right">
                        ${getTimestamp()}
                    </div>
                </div>
            `;
            chatArea.appendChild(messageWrapper);

            // 3. Scroll to the bottom to show the newest message
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        }

        function showSpinner() {
            loadingSpinner.classList.remove('hidden');
            document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
        }

        function hideSpinner() {
            loadingSpinner.classList.add('hidden');
        }

        async function fetchToRasa(text, attempt = 1) {
            showSpinner();
            
            // NOTE: Using 'user' as a placeholder sender ID for Rasa API
            const payload = {
                sender: "user_12345", 
                message: text
            };

            try {
                const response = await fetch(`${RASA_SERVER_URL}/webhooks/rest/webhook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Rasa API Error: ${response.statusText}`);
                }

                const data = await response.json();
                hideSpinner();

                if (data && data.length > 0) {
                    data.forEach(message => {
                        if (message.text) {
                            addMessage(message.text, false); // Bot message
                        }
                        // Handle other message types like buttons/images if needed
                    });
                } else {
                    addMessage("Sorry, I didn't receive a response from the assistant.", false);
                }

            } catch (error) {
                console.error("Fetch failed:", error);

                if (attempt < maxRetries) {
                    const delay = Math.pow(2, attempt) * 1000; // Exponential backoff (2s, 4s, 8s)
                    console.log(`Retrying in ${delay / 1000} seconds...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    await fetchToRasa(text, attempt + 1); // Retry with incremented attempt
                } else {
                    hideSpinner();
                    addMessage("I'm having trouble connecting to the assistant right now. Please check the server URL and try again later.", false);
                }
            }
        }

        async function sendMessage() {
            const text = inputField.value.trim();
            if (text === '') return;

            // Clear input and disable button
            inputField.value = '';
            sendButton.disabled = true;

            // Display user message
            addMessage(text, true);

            // Fetch bot response
            await fetchToRasa(text);
        }

    </script>
</body>
</html>